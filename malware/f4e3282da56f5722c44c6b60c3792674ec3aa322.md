# f4e3282da56f5722c44c6b60c3792674ec3aa322

**Takeaway message:** even **9** year after its diffusion, **40 / 70** AV will not detected some basic malware.

A few years ago (around 10 years), one of my favorite activities was to search for mainstream malware on sites like YouTube.
While it's less prevalent today than back then, it was very easy to find stealer or other malware by searching for something like "hack {insert name of a known multiplayer game} {insert name of game currency}" or "hack {famous platform}".

I tried again today, and even if the results are rather dated, we still find some nuggets.
For this analysis, we are tackling a "hack" for the Dofus game (a MMORPG) supposed to generate Kamas, the game's currency.

Let's start.
We begin with a file named `hackamas.rar`.
> [virustotal.com : hackamas.rar](https://www.virustotal.com/gui/file/951229c71c41472a3b695d88dfc2e5ea4d39987334dc97c7f6366d4738911ae8)

We unrar the file and go with the only file in it : `hack facebook.exe`.
I'm not joking here, the PE filename do not even match the supposed reason we downloaded the hack, but anyway.
> [virustotal.com : hack facebook.exe](https://www.virustotal.com/gui/file/96f487ee0a19696cb67a4ea28b111323e7ce2e6c0e691d2a3c81b62bc36410ec)

As you can see, even 9 year after, only 30 / 70 AV detect the file as malicious.

If we scan the file, we can see that it is a .Net program which is Obfus/Crypted.

![image](https://github.com/Cyril-Meyer/RCE/assets/69190238/ac3e022a-cb3d-4b39-9027-44e077059601)

Using dnSpy, we easily understand that the program is obfuscated using CodeWall.

![image](https://github.com/Cyril-Meyer/RCE/assets/69190238/b6d2e2a9-d7b9-4596-bdf9-e9b42b2a1223)

Fortunately, the de4dot software handles this obfuscator very well, so we can use it to unobfuscate the code.

![image](https://github.com/Cyril-Meyer/RCE/assets/69190238/f25726af-9c4a-403c-b704-a5dcff55f571)

If we look at the source using dnSpy, we can see that there is still an obfuscation.
Another times, de4dot do the job for us.

![image](https://github.com/Cyril-Meyer/RCE/assets/69190238/76780208-d91c-4d09-96c8-7bb9bf6ee34d)

Now that we bypassed the obfuscation, we can analyze the `Main` function.

```
private static void Main(string[] args)
{
	try
	{
		using (Stream manifestResourceStream = typeof(Class6).Assembly.GetManifestResourceStream("a.zip"))
		{
			using (Package package = Package.Open(manifestResourceStream, FileMode.Open, FileAccess.Read))
			{
				Assembly assembly = Class6.smethod_0(package, "/sdsd.exe");
				assembly.EntryPoint.Invoke(null, new object[0]);
			}
		}
	}
	catch (Exception ex)
	{
		MessageBox.Show(string.Concat(new string[]
		{
			ex.GetType().Name,
			Environment.NewLine,
			ex.Message,
			Environment.NewLine,
			ex.StackTrace
		}));
	}
}
```

The function is easy to understand, the program load a file from the ressources named `a.zip` and run the assembly named `sdsd.exe` inside it.

So let's work on this zip file and its `sdsd.exe` PE.
> [virustotal.com : sdsd.exe](https://www.virustotal.com/gui/file/bb243adc5e7e9d2cbcb311912e25052b3287d4351f9f33ee2ec35e5e75e07ac6)

Fun fact, I seems to be the first person to send this to virustotal.com:  
![image](https://github.com/Cyril-Meyer/RCE/assets/69190238/ca1c4da0-bb5e-4ab3-bb03-37ed63bdb781)

The program isn't really obfuscated, and we can see that the main function calls `OK.ko()`

```
public class A
{
	// Token: 0x0600002F RID: 47 RVA: 0x00004B24 File Offset: 0x00002D24
	[STAThread]
	public static void main()
	{
		OK.ko();
	}
}
```

At first, the program install itself in the computer and start 2 threads.
To summarize, the program establishes a TCP connection with a server defined in the class.
After that, the process is started with the computer and act like a `trojan`.

The TCP connection is made to `ngnl9.ddns.net` (which is obviously down now) on port `81`, so theres nothing much we need to do as the malware is already not active anymore !
